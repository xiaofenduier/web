<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>库存管理系统</title>
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width">        
  <script type="text/javascript" src="view/js/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="view/js/bootstrap.min.js"></script>
<script type="text/javascript" src="view/js/bootstrap-paginator.min.js"></script>
<script type="text/javascript" src="view/js/moment.js"></script>
<script type="text/javascript" src="view/js/daterangepicker.js"></script>
<script src="view/js/bootstrapValidator.min.js"></script>

<link href="http://www.jq22.com/jquery/font-awesome.4.6.0.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" media="all" href="view/css/daterangepicker-bs3.css"/>
<link rel="stylesheet" type="text/css" href="view/css/bootstrap.min.css">
<link rel="stylesheet" href="view/css/templatemo_main.css">
<link rel="stylesheet" type="text/css" href="view/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="view/css/bootstrapValidator.min.css">

</head>
<body>
<script type="text/javascript">
$(document).ready(function() {
	/* 验证码 */
	function randomNumber(min, max) {
				return Math.floor(Math.random()* (max - min + 1) + min);
			};
			function generateCaptcha() {
				$('#captchaOperation').html([randomNumber(1, 50), '+',randomNumber(1, 50), '=' ].join(' '));
			};
			generateCaptcha();
				$('#LoginG').bootstrapValidator(
					{
						feedbackIcons : {
						valid : 'glyphicon glyphicon-ok',
						invalid : 'glyphicon glyphicon-remove',
						validating : 'glyphicon glyphicon-refresh'
					},
				fields : {
					Username : {
						message : 'The username is not valid',
						validators : {
							notEmpty : {
								message : '账户不能为空'
							},
							/* stringLength : {
								min : 5,
								max : 10,
								message : '账号长度 5-10'
							}, */
							regexp : {
								regexp : /^[a-zA-Z0-9_\.]+$/,
								message : '只接受数字和字母 '
							}
						}
					},
					Password : {
						validators : {
							notEmpty : {
								message : '密码不能为空'
							}
						}
					},
					captcha : {
						validators : {
							callback : {
								message : '验证码错误',
								callback : function(value,validator) {
									var items = $('#captchaOperation').html().split(' '), 
									sum = parseInt(items[0])+ parseInt(items[2]);
									return value == sum;
								}
							}
						}
					}
				}
			}).on('error.form.bv',function(e) {
				var $form = $(e.target), bootstrapValidator = $form.data('bootstrapValidator');
				if (!bootstrapValidator.isValidField('captcha')) {
					generateCaptcha();
				}
			});
				
	$.ajax({
		type : 'POST',
		dataType : "json",
		url : "user/getUser",
		success : function(data) {
			if(data.data == null){
				$("#logincontain").show();
				$("#welcomecontain").hide();
			}else{
				$("#welcomecontain").show();
				$("#logincontain").hide();
				var outdCount = 0;
				var outrCount = 0;
				var buydCount = 0;
				var buyrCount = 0;
				var roleName = data.data.roleName;
				var id = data.data.id;
				if(roleName == "root"){
					$("#quanxian").show();
					$("#welcome").html("欢迎<em>管理员</em><strong>"+data.data.name+"</strong>登录</br>");
				}else{
					$("#quanxian").hide();
				}
				$.ajax({
					type : 'POST',
					dataType : "json",
					url : "index/countwithstate",
					data : {
						staffId : id
					},
					success : function(data1) {
						outdCount = data1.outdCount;
						outrCount = data1.outrCount;
						buydCount = data1.buydCount;
						buyrCount = data1.buyrCount;
						if(roleName == "manager"){
							$("#welcome").html("欢迎<em>经理</em><strong>"+data.data.name+"</strong>登录</br>您有<strong>"+buydCount+"</strong>个采购单未处理<strong>"+outdCount+"</strong>个出货单未处理");
						}
						if(roleName == "staff"){
							$("#welcome").html("欢迎<em>员工</em><strong>"+data.data.name+"</strong>登录</br>您有<strong>"+buyrCount+"</strong>个采购单被拒绝<strong>"+outrCount+"</strong>个出货单被拒绝");
						}
					}
				});
			}
		}
	});
});
function login(){
	var username = $("#username").val();
	var password = $("#password").val();
	$.ajax({
		type : 'POST',
		dataType : "json",
		url : "user/login",
		data : {
			"username" :　username,
			"password" : password
		},
		success : function(data) {
			if(data == null){
				alert("登录失败");
			}else{
				$("#logincontain").hide();
				$("#welcomecontain").show();
				var outdCount = 0;
				var outrCount = 0;
				var buydCount = 0;
				var buyrCount = 0;
				var roleName = data.roleName;
				var id = data.id;
				if(roleName == "root"){
					$("#quanxian").show();
					$("#welcome").html("欢迎<em>管理员</em><strong>"+data.name+"</strong>登录</br>");
				}else{
					$("#quanxian").hide();
				}
				$.ajax({
					type : 'POST',
					dataType : "json",
					url : "index/countwithstate",
					data : {
						staffId : id
					},
					success : function(data1) {
						outdCount = data1.outdCount;
						outrCount = data1.outrCount;
						buydCount = data1.buydCount;
						buyrCount = data1.buyrCount;
						if(roleName == "manager"){
							$("#welcome").html("欢迎<em>经理</em><strong>"+data.name+"</strong>登录</br>您有<strong>"+buydCount+"</strong>个采购单未处理<strong>"+outdCount+"</strong>个出货单未处理");
						}
						if(roleName == "staff"){
							$("#welcome").html("欢迎<em>员工</em><strong>"+data.name+"</strong>登录</br>您有<strong>"+buyrCount+"</strong>个采购单被拒绝<strong>"+outrCount+"</strong>个出货单被拒绝");
						}
					}
				});
			
			}
		}
	});
}
</script>
	<div id="main-wrapper">
		<div class="navbar navbar-inverse" role="navigation">
			<div class="navbar-header">
				<div class="logo">
					<h1>库存管理系统</h1>
				</div>
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="sr-only">库存管理系统</span> <span class="icon-bar"></span>
					<span class="icon-bar"></span> <span class="icon-bar"></span>
				</button>
			</div>
		</div>
		<div class="template-page-wrapper">
			<div class="navbar-collapse collapse templatemo-sidebar">
				<ul class="templatemo-sidebar-menu">
					<li class="active"><a href="index.html"><i
							class="fa fa-home"></i>首页</a></li>
					<li><a href="production.html"><i class="fa fa-cubes"></i>产品管理</a></li>
					<li><a href="buy.html"><i class="fa fa-map-marker"></i>进货管理</a></li>
					<li><a href="out.html"><i class="fa fa-users"></i>出货管理</a></li>
					<li><a href="stock.html"><i class="fa fa-cog"></i>库存管理</a></li>
					<li id ="quanxian" style = "display:none"><a href="user.html"><i class="fa fa-cog"></i>权限管理</a></li>
				</ul>
			</div>
			<div class="col-md-offset-4 col-md-4" id="logincontain"
				style="display: none">
				<div class="panel panel-primary" style="margin-top: 3em;">
					<div id="myTabContent" class="tab-content">
						<div class="tab-pane fade in active" id="Prv">
							<div class="well well-sm ">
								<h3 class="panel-title">用户登陆</h3>
							</div>
							<div class="panel-body">
								<form name="LoginG" id="LoginG" method="post" target="_parent">
									<div class="form-group">
										<div class="input-group">
											<span class="input-group-addon">账号</span> <input
												name="Username" type="text" id="username"
												class="form-control" placeholder="Username">
											<!--<span class="help-block" id="UsernameMessage" /> -->
										</div>
										<br />
									</div>
									<!-- /form-group-->
									<div class="form-group">
										<div class="input-group">
											<span class="input-group-addon">密码</span> <input
												name="Password" type="Password" id="password"
												class="form-control" placeholder="Password">
											<!--<span class="help-block" id="PasswordMessage" /> -->
										</div>
									</div>
									<!-- /form-group-->
									<h5>请将如下计算结果填入文本框内：</h5>
									<div class="form-group form-horizontal">
										<label class="col-lg-3 control-label " id="captchaOperation"></label>
										<div class="col-lg-9">
											<input type="text" class="form-control " name="captcha" />
										</div>
									</div>
									<br /> <br /> <br />
									<div class="form-group">
										<input class="btn btn-primary btn-block" type="submit"
											value="登　　录" onclick="login()" />
									</div>
								</form>
							</div>
							<!-- /panel-body -->
						</div>

					</div>
					<!--myTabContent-->
				</div>
			</div>
		</div>

		<br />
		<!-- 欢迎语 -->
		<div class="templatemo-content-wrapper" id="welcomecontain"
			style="display: none">
			<div class="templatemo-content">

				<div class="container">
					<div class="row clearfix">
						<div class="col-md-12 column">
							<p id="welcome"></p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>