<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    <!-- Bootstrap styles -->
    <link href="vendors/bootstrap-datetimepicker/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="vendors/bootstrap-datetimepicker/bootstrap/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
   
    <!-- Font-Awesome -->
    <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">

    <!-- Google Webfonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600|PT+Serif:400,400italic' rel='stylesheet' type='text/css'>

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css" id="theme-styles">
    <!--[if lt IE 9]>      
        <script src="js/respond.js"></script>
    <![endif]-->
    <script type="text/javascript" src="vendors/bootstrap-datetimepicker/jquery/jquery-1.8.3.min.js" charset="UTF-8"></script>
	<script type="text/javascript" src="vendors/bootstrap-datetimepicker/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="vendors/bootstrap-datetimepicker/bootstrap/js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
	<script type="text/javascript" src="vendors/bootstrap-datetimepicker/bootstrap/js/locales/bootstrap-datetimepicker.fr.js" charset="UTF-8"></script>
    <script src="js/modernizr.js"></script>
    <script src="vendors/bootstrap/dist/js/bootstrap-paginator.min.js"></script>
    <script type="text/javascript">
    var changdiname;
    var changdiid;
    var userid;
    var money;
    var cost;
    var useryue;
    function quit(){
    	$.ajax({
    		type : "POST",
    		dataType : "json",
    		url : "user/quit",
    		data : {
    			"id" : userid
    		},
    		success : function(data) {
    			if(data > 0){
    				alert("注销成功");
    				$("#modal-container-170348").modal("toggle");
    				location.reload();
    			}
    		}
    	});
    }
    function order(){
    	if($("#datetimeStart").val() == "" || $("#datetimeEnd").val() == ""){
    		alert("请选择时间");
    		return;
    	}
    	if(money > 0){
    		useryue = money - cost;
    		if(useryue < 0){
    			alert("余额不足，请充值！");
    			return;
    		}
    	}
    	if(money == 0){
    		$("#ye").hide();
    	}
    	$("#modal-container-445190").modal();
    }
    function pay(){
    	alert(money);
    	alert(cost);
    	alert(useryue);
    	$.ajax({
			type : 'POST',
			dataType : "json",
			url : "dingdan/add",
			data : {
				"userid" : userid,
				"changdiid" : changdiid,
				"starttime" : $("#datetimeStart").val(),
				"endtime" : $("#datetimeEnd").val(),
				"money" : useryue
			},
			success : function(data) {
				if(data > 0){
					alert("已付费,预订成功！");
				}else if(data == -1){
					alert("付费失败,此时间段内此场地已被预订！");
				}
			}
		});
    	$("#modal-container-445190").modal("toggle");
    }
    
    function pingjia(){
    	$.ajax({
			type : "POST",
			dataType : "json",
			url : "user/islogin",
			success : function(data) {
				if (data.data == null) {
					alert("请先登录!");
					location.href = "userLogin.html";
					return;
				} else {
					userid = data.data.id;
					$("#name").val(data.data.realname);
					$("#phone").val(data.data.telphone);
					$("#yue").val(data.data.money);
					money = data.data.money;
					$("#modal-container-445198").modal();
					$("#msg").html("欢迎登录"+data.data.username);
					$("#log").hide();
    				$("#reg").hide();
    				$("#myyue").val(data.data.money);
				}
			}
		});
	}
    
    function addpingjia(){
    	var score = $("#score").val();
    	if(score < 0 || score > 5){
    		alert("评分只能在1和5之间");
    		return;
    	}
    	$.ajax({
			type : "POST",
			dataType : "json",
			url : "pingjia/add",
			data : {
				"score" : score,
				"changdiid" : changdiid,
				"userid" : userid,
				"pingjia" : $("#pingjia2").val()
			},
			success : function(data) {
				if(data != null){
					alert("评价成功");
					$("#modal-container-445198").modal("toggle");
				}
			}
    	});
    }
    
    function yuding(){
    	$.ajax({
			type : "POST",
			dataType : "json",
			url : "user/islogin",
			success : function(data) {
				if (data.data == null) {
					alert("请先登录!");
					location.href = "userLogin.html";
					return;
				} else {
					userid = data.data.id;
					$("#name").val(data.data.realname);
					$("#phone").val(data.data.telphone);
					$("#yue").val(data.data.money);
					money = data.data.money;
					$("#myyue").val(data.data.money);
				}
			}
		});
		$("#modal-container-445199").modal();
		$("#changdiname").val(changdiname);
	}
    
    $(document).ready(function() {
    	var url = location.href; 
    	var id = url.split("=")[1];
    	$.ajax({
    		type : "POST",
    		dataType : "json",
    		url : "user/islogin",
    		success : function(data) {
    			if (data.data == null) {
    				$("#logmsg").hide();
    				$("#quit").hide();
    			} else {
    				$("#log").hide();
    				$("#reg").hide();
    				$("#msg").html("欢迎"+data.data.username);
    			}
    		}
    	});
    	$.ajax({
			type : 'POST',
			dataType : "json",
			url : "changdi/selectbyid",
			data : {
				"id" : id
			},
			success : function(data) {
				var content = '<div class="row"><div class="col-md-6 col-sm-6"><article class=" blog-teaser"><header><img src="'+data.pic+'" alt=""><h3><a href="changdi_detail.html?id='+data.id+'">'+data.name+'</a></h3><hr></header></article></div><div class="col-md-4 col-sm-4" style="margin-top:20px"><h3>地址：'+data.address+'</h3><br/><h3>联系方式：'+data.telphone+'</h3><br/><h3>管理员：'+data.admin+'</h3><br/><h3>介绍：'+data.introduce+'</h3><br/><button id="modal-445199" role="button" class="btn" data-toggle="modal" onclick = "yuding()"><h2>预定</h2></button></div><br/><button id="modal-445198" role="button" class="btn" data-toggle="modal" onclick = "pingjia()" style = "margin-top:340px"><h2>评价</h2></button></div>';
				$("#table").html(content);
				changdiname = data.name;
				changdiid = data.id;
				cost = data.price;
			}
    	});
    	
    	$("#datetimeStart").datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            language: 'zh-CN',
            autoclose:true,
            startDate:new Date()
        }).on("click",function(){
            $("#datetimeStart").datetimepicker("setEndDate",$("#datetimeEnd").val())
        });
        $("#datetimeEnd").datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            language: 'zh-CN',
            autoclose:true,
            startDate:new Date()
        }).on("click",function(){
            $("#datetimeEnd").datetimepicker("setStartDate",$("#datetimeStart").val())
        });
    	
    	/* 加载评价 */
    	$.ajax({
    		type : 'POST',
    		dataType : "json",
    		url : "pingjia/selectwithpage",
    		data : {
    			"currentPage" : 1,
    			"pageSize" : 3,
    			"changdiid" : id
    		},
    		success : function(data) {
    			var result = data.data;
    			var pingjia = "";
    			$.each(result, function(i,resultObj) {
    				pingjia += '<li style = "width:900px">'+resultObj.pingjia+'</li>';
    			});
    			$("#pingjia").html(pingjia);
    			
    			var pageSize = data.pageSize;
    			var pageCount = data.pageCount;
    			var currentPage = data.currentPage;
    			var options = {
    				currentPage : currentPage,
    				totalPages : pageCount,
    				size : "normal",
    				bootstrapMajorVersion : 3,
    				alignment : "right",
    				numberOfPages : pageSize,
    				itemTexts : function(type, page, current) {
    					switch (type) {
    					case "first":
    						return "首页";
    					case "prev":
    						return "上一页";
    					case "next":
    						return "下一页";
    					case "last":
    						return "末页";
    					case "page":
    						return page;
    					}
    				},
    				//点击事件，用于通过Ajax来刷新整个list列表
    				onPageClicked : function(event, originalEvent,type, page) {
    					$.ajax({
    						type : 'POST',
    						dataType : "json",
    						url : "pingjia/selectwithpage",
    						data : {
    							"currentPage" : page,
    							"pageSize" : pageSize,
    							"changdiid" : id
    						},
    						success : function(data) {
    							var resultwithpage = data.data;
    							var pingjiawithpage = "";
    							$.each(resultwithpage, function(i, resultwithpageObj) {
    								pingjiawithpage += '<li style = "width:900px">'+resultwithpageObj.pingjia+'</li>';
    							});
    							$("#pingjia").html(pingjiawithpage);
    						}
    					});
    				}
    			};
    			$('#pageLimit').bootstrapPaginator(options);
    		}
    	});
    });
    function quit(){
    	$.ajax({
    		type : "POST",
    		dataType : "json",
    		url : "user/quit",
    		data : {
    			"id" : userid
    		},
    		success : function(data) {
    			if(data > 0){
    				alert("注销成功");
    				$("#modal-container-170348").modal("toggle");
    				location.reload();
    			}
    		}
    	});
    }
    </script>
</head>
<body>
    <header>
        <div class="widewrapper subheader">
            <div class="container">
                <nav class="pull-right clean-nav">
                    <div class="collapse navbar-collapse">
                        <ul class="nav nav-pills navbar-nav">
                            <li>
                                <a href="index.html">首页</a>
                            </li>
                            <li>
                                <a href="changdi.html">场地列表</a>
                            </li>
                            <li>
                                <a href="chongzhi.html">账户充值</a>
                            </li>
                            <li>
                                <a href="mydingdan.html">我的预定</a>
                            </li>
                            <li>
                                <a href="userinfo.html">修改个人信息</a>
                            </li>
                            <li id = "reg">
                                <a href="register.html">注册</a>
                            </li>  
                            <li id = "log">
                                <a href="userLogin.html">登录</a>
                            </li>
                            <li id = "quit">
                                <a href="#modal-container-170348" data-toggle="modal">注销</a>
                            </li>
                            <li id = "rlogin">
                                <a href="rootLogin.html">后台登录</a>
                            </li>
                            <li id = "chakanyue">
                                <a href="#modal-container-770346" data-toggle="modal">查看余额</a>
                            </li>
                        </ul>
                    </div>
                </nav>
                <p id = "msg" style = "margin-left:-50px;margin-top:20px"></p>
            </div>
        </div>

    </header>

    <div class="widewrapper main">
        <div class="container">
            <div class="row">
                <div class="col-md-12 blog-main" id = "table">
                    
                </div>
            </div>
        </div>
    </div>
    
    <div class="widewrapper main">
        <div class="container">
            <div class="row">
                <aside class="col-md-4 blog-aside">
                	<div class="body">
                    	<ul class="clean-list"  id = "pingjia">
                        </ul>
                        <div id="example" style="text-align: right">
							<ul id="pageLimit"></ul>
						</div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <footer>
        <div class="widewrapper footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-4 footer-widget">
                       <h3> <i class="fa fa-user"></i>地址</h3>
                       <p>啪啪啪啪啪路啪啪啪啪街啪啪啪啪啪啪号</p>
                    </div>

                    <div class="col-md-4 footer-widget">
                        <h3> <i class="fa fa-envelope"></i>联系方式</h3>
                        <p>18301057019</p>
                    </div>
                   
                </div>
            </div>
        </div>
    </footer>
    <div class="modal fade" id="modal-container-445198" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">×</button>
					<h4 class="modal-title" id="myModalLabel">评价</h4>
				</div>
				<div class="modal-body">
				<label for="exampleInputEmail1">评分</label>
                <input type="number" id="score" name="score" required="required" data-validate-minmax="1,5" class="form-control col-md-7 col-xs-12">
				<br/>
				<label for="exampleInputEmail1">评价</label>
				<input type="text" name="pingjia2" id="pingjia2" class="form-control input-lg">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" onclick = "addpingjia()">评价</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="modal-container-445199" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">×</button>
					<h4 class="modal-title" id="myModalLabel">场地预定</h4>
				</div>
				<div class="modal-body">
					<input type="text" name="changdiname" id="changdiname" readonly class="form-control input-lg">
					<br/>
					开始时间：<input type="text" size="16" id="datetimeStart" readonly class="form_datetime">
					--
					结束时间：<input type="text" size="16" id="datetimeEnd" readonly class="form_datetime">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" onclick = "order()">前往付费</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 付费 -->
	<div class="modal fade" id="modal-container-445190" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title" id="myModalLabel">付费</h4>
				</div>
				<div class="modal-body">
					<button type="button" class="btn btn-default" id = "ye" onclick = "pay()">从余额扣除</button>
					<button type="button" class="btn btn-primary" onclick = "pay()">付费</button>
				</div>
			</div>
		</div>
	</div>
<!-- 查看余额 -->
	<div class="container">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<div class="modal fade" id="modal-container-770346" role="dialog"
					aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal"
									aria-hidden="true">×</button>
								<h4 class="modal-title" id="myModalLabel">我的余额</h4>
							</div>
							<div class="modal-body">
								<label for="exampleInputEmail1">我的余额</label>
								<input type="text" name="myyue" id="myyue" readonly class="form-control input-lg">
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default"
									data-dismiss="modal">关闭</button>
								<button type="button" class="btn btn-primary" id="remove">确认</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 注销 -->
	<div class="container">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<div class="modal fade" id="modal-container-170348" role="dialog"
					aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal"
									aria-hidden="true">×</button>
								<h4 class="modal-title" id="myModalLabel">注销</h4>
							</div>
							<div class="modal-body">
								<p id="delete">确认注销？</p>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default"
									data-dismiss="modal">关闭</button>
								<button type="button" class="btn btn-primary" id="quit" onclick="quit()">确认</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>